{% extends "member/base_member.html" %}
{% load static %}

{% block title %}Renew Membership{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 2rem;
        text-align: center;
    }
    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.5rem 0;
    }
    .page-subtitle {
        color: #64748b;
        font-size: 1rem;
        margin: 0;
    }

    .renewal-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        align-items: start;
    }
    @media (max-width: 1024px) {
        .renewal-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Current Status Hero */
    .status-hero {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        padding: 2rem;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    .status-hero-icon {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.25rem;
    }
    .status-hero-icon i {
        width: 36px;
        height: 36px;
    }
    .status-hero-icon.active {
        background: #d1fae5;
        color: #059669;
    }
    .status-hero-icon.expiring {
        background: #fef3c7;
        color: #d97706;
    }
    .status-hero-icon.expired {
        background: #fee2e2;
        color: #dc2626;
    }
    .status-hero-icon.none {
        background: #f1f5f9;
        color: #64748b;
    }
    .status-hero h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 0.5rem 0;
    }
    .status-hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin-bottom: 1.5rem;
    }
    .status-hero-badge.active {
        background: #d1fae5;
        color: #059669;
    }
    .status-hero-badge.expiring {
        background: #fef3c7;
        color: #d97706;
    }
    .status-hero-badge.expired {
        background: #fee2e2;
        color: #dc2626;
    }
    .status-hero-badge.none {
        background: #f1f5f9;
        color: #64748b;
    }

    /* Countdown Timer */
    .countdown-section {
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }
    .countdown-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        text-align: center;
    }
    .countdown-timer {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }
    .countdown-item {
        text-align: center;
        min-width: 60px;
    }
    .countdown-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
        padding: 0.75rem;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        margin-bottom: 0.35rem;
    }
    .countdown-unit {
        font-size: 0.7rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .countdown-expired {
        text-align: center;
        padding: 1rem;
        background: #fee2e2;
        border-radius: 8px;
        color: #dc2626;
        font-weight: 600;
    }

    .member-info-row {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
    }
    .member-info-item {
        text-align: center;
    }
    .member-info-label {
        font-size: 0.7rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0.25rem;
    }
    .member-info-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: #1e293b;
    }

    /* Membership Fee Usage message - clean design, no gradients */
    .fee-usage-box {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-left: 4px solid #0f172a;
        border-radius: 12px;
        padding: 1.5rem 1.75rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04);
    }
    .fee-usage-box h4 {
        font-size: 1rem;
        font-weight: 700;
        color: #0f172a;
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.65rem;
        letter-spacing: -0.01em;
    }
    .fee-usage-box h4 .fee-usage-icon-wrap {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: #f1f5f9;
        color: #475569;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .fee-usage-box h4 .fee-usage-icon-wrap i {
        width: 20px;
        height: 20px;
    }
    .fee-usage-box p {
        font-size: 0.9375rem;
        color: #475569;
        line-height: 1.65;
        margin: 0 0 0.75rem 0;
    }
    .fee-usage-box p:last-child {
        margin-bottom: 0;
    }

    /* Plan Selection */
    .plans-section {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 1.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .section-title i {
        width: 20px;
        height: 20px;
        color: #64748b;
    }

    .plans-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    @media (max-width: 600px) {
        .plans-grid {
            grid-template-columns: 1fr;
        }
    }

    .plan-card {
        position: relative;
        padding: 1.25rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
    }
    .plan-card:hover {
        border-color: #cbd5e1;
    }
    .plan-card.selected {
        border-color: #1e293b;
        background: #fafafa;
    }
    .plan-card.popular {
        border-color: #1e293b;
    }
    .plan-card.popular::before {
        content: 'Most Popular';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.25rem 0.75rem;
        background: #1e293b;
        color: #fff;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        border-radius: 4px;
        letter-spacing: 0.03em;
    }
    .plan-card input {
        display: none;
    }

    .plan-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    .plan-duration {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
    }
    .plan-check {
        width: 22px;
        height: 22px;
        border: 2px solid #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .plan-card.selected .plan-check {
        background: #1e293b;
        border-color: #1e293b;
    }
    .plan-card.selected .plan-check i {
        display: block;
    }
    .plan-check i {
        display: none;
        width: 14px;
        height: 14px;
        color: #fff;
    }

    .plan-price-row {
        display: flex;
        align-items: baseline;
        gap: 0.35rem;
        margin-bottom: 0.5rem;
    }
    .plan-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }
    .plan-currency {
        font-size: 0.85rem;
        color: #64748b;
    }
    .plan-period {
        font-size: 0.8rem;
        color: #94a3b8;
    }

    .plan-desc {
        font-size: 0.8rem;
        color: #64748b;
    }
    .plan-savings-badge {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.2rem 0.5rem;
        background: #d1fae5;
        color: #059669;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 4px;
    }

    /* Benefits */
    .benefits-section {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
    }
    .benefits-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    @media (max-width: 600px) {
        .benefits-grid {
            grid-template-columns: 1fr;
        }
    }
    .benefit-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
    }
    .benefit-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: #d1fae5;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .benefit-icon i {
        width: 16px;
        height: 16px;
        color: #059669;
    }
    .benefit-text {
        font-size: 0.85rem;
        color: #475569;
        line-height: 1.4;
    }

    /* Sidebar Summary */
    .summary-sidebar {
        position: sticky;
        top: 1rem;
    }
    .summary-card {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }
    .summary-header {
        padding: 1.25rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .summary-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .summary-header h3 i {
        width: 18px;
        height: 18px;
        color: #64748b;
    }
    .summary-body {
        padding: 1.5rem;
    }
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .summary-row:last-of-type {
        margin-bottom: 0;
    }
    .summary-label {
        font-size: 0.9rem;
        color: #64748b;
    }
    .summary-value {
        font-size: 0.9rem;
        font-weight: 500;
        color: #1e293b;
    }
    .summary-divider {
        height: 1px;
        background: #e2e8f0;
        margin: 1.25rem 0;
    }
    .summary-total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .summary-total-label {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
    }
    .summary-total-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
    }

    .summary-footer {
        padding: 1.5rem;
        background: #fafafa;
        border-top: 1px solid #e2e8f0;
    }
    .btn-pay {
        width: 100%;
        padding: 1rem 1.5rem;
        background: #1e293b;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.15);
    }
    .btn-pay:hover {
        background: #334155;
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(30, 41, 59, 0.2);
    }
    .btn-pay:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .btn-pay i {
        width: 20px;
        height: 20px;
    }

    .payment-methods {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.25rem;
        padding-top: 1.25rem;
        border-top: 1px solid #e2e8f0;
    }
    .payment-method {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #64748b;
    }
    .payment-method i {
        width: 16px;
        height: 16px;
    }

    .secure-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f0fdf4;
        border-radius: 8px;
        font-size: 0.8rem;
        color: #15803d;
        font-weight: 500;
    }
    .secure-badge i {
        width: 16px;
        height: 16px;
    }

    /* Success Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-overlay.active {
        display: flex;
    }
    .success-modal {
        background: #fff;
        border-radius: 20px;
        width: 90%;
        max-width: 420px;
        text-align: center;
        padding: 2.5rem 2rem;
        animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .success-icon-wrapper {
        width: 100px;
        height: 100px;
        background: #d1fae5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        position: relative;
    }
    .success-icon-wrapper::after {
        content: '';
        position: absolute;
        width: 120px;
        height: 120px;
        border: 2px solid #d1fae5;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.5; }
    }
    .success-icon-wrapper i {
        width: 48px;
        height: 48px;
        color: #059669;
    }
    .success-modal h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.5rem 0;
    }
    .success-modal p {
        color: #64748b;
        font-size: 0.95rem;
        margin: 0 0 1.5rem 0;
    }
    .success-details {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }
    .success-detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e2e8f0;
    }
    .success-detail-row:last-child {
        border-bottom: none;
    }
    .success-detail-label {
        color: #64748b;
        font-size: 0.85rem;
    }
    .success-detail-value {
        font-weight: 600;
        color: #1e293b;
    }
    .btn-done {
        width: 100%;
        padding: 0.9rem 2rem;
        background: #1e293b;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-done:hover {
        background: #334155;
    }

    /* Loading State */
    .btn-pay.loading {
        position: relative;
        color: transparent;
    }
    .btn-pay.loading::after {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        border: 3px solid transparent;
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Renew Your Membership</h1>
    <p class="page-subtitle">Continue supporting the movement and access exclusive member benefits</p>
</div>

<div class="renewal-layout">
    <div class="renewal-main">
        <!-- Status Hero -->
        <div class="status-hero">
            <div class="status-hero-icon {% if renewal_status == 'active' %}active{% elif renewal_status == 'expiring_soon' %}expiring{% elif renewal_status == 'expired' %}expired{% else %}none{% endif %}">
                {% if renewal_status == 'active' %}
                    <i data-lucide="shield-check"></i>
                {% elif renewal_status == 'expiring_soon' %}
                    <i data-lucide="clock"></i>
                {% elif renewal_status == 'expired' %}
                    <i data-lucide="shield-x"></i>
                {% else %}
                    <i data-lucide="shield-question"></i>
                {% endif %}
            </div>
            <h2>
                {% if renewal_status == 'active' %}Your Membership is Active
                {% elif renewal_status == 'expiring_soon' %}Your Membership is Expiring Soon
                {% elif renewal_status == 'expired' %}Your Membership has Expired
                {% else %}Start Your Membership
                {% endif %}
            </h2>
            <span class="status-hero-badge {% if renewal_status == 'active' %}active{% elif renewal_status == 'expiring_soon' %}expiring{% elif renewal_status == 'expired' %}expired{% else %}none{% endif %}">
                {% if renewal_status == 'active' %}Active{% elif renewal_status == 'expiring_soon' %}Expiring Soon{% elif renewal_status == 'expired' %}Expired{% else %}Not Active{% endif %}
            </span>

            <!-- Countdown Timer -->
            {% if subscription_end %}
            <div class="countdown-section">
                <div class="countdown-label">
                    {% if renewal_status == 'expired' %}Expired Since{% else %}Time Remaining{% endif %}
                </div>
                <div class="countdown-timer" id="countdownTimer" data-end="{{ subscription_end_iso }}">
                    <div class="countdown-item">
                        <div class="countdown-value" id="countDays">--</div>
                        <div class="countdown-unit">Days</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-value" id="countHours">--</div>
                        <div class="countdown-unit">Hours</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-value" id="countMins">--</div>
                        <div class="countdown-unit">Mins</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-value" id="countSecs">--</div>
                        <div class="countdown-unit">Secs</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="member-info-row">
                <div class="member-info-item">
                    <div class="member-info-label">Member ID</div>
                    <div class="member-info-value">{{ member_id }}</div>
                </div>
                <div class="member-info-item">
                    <div class="member-info-label">Valid Until</div>
                    <div class="member-info-value">{{ subscription_end|default:"Not Active" }}</div>
                </div>
            </div>
        </div>

        <!-- Membership Fee Usage -->
        <div class="fee-usage-box">
            <h4><span class="fee-usage-icon-wrap"><i data-lucide="info"></i></span> Membership Fee Usage</h4>
            <p>Your membership contribution directly supports the ongoing operation of our platform. Fees are used for secure server hosting, website maintenance, system upgrades, cybersecurity, and the continuous improvement of digital tools that keep the movement active, reliable, and accessible.</p>
            <p>This ensures uninterrupted service, data protection, and a high-quality experience for all members.</p>
        </div>

        <!-- Plan Selection -->
        <div class="plans-section">
            <h3 class="section-title">
                <i data-lucide="calendar"></i>
                Choose Your Plan
            </h3>
            <div class="plans-grid">
                <label class="plan-card selected" onclick="selectPlan(this, 1)">
                    <input type="radio" name="plan" value="1" checked>
                    <div class="plan-header">
                        <span class="plan-duration">1 Month</span>
                        <div class="plan-check">
                            <i data-lucide="check"></i>
                        </div>
                    </div>
                    <div class="plan-price-row">
                        <span class="plan-currency">GHS</span>
                        <span class="plan-price">{{ membership_fee_ghs|floatformat:2 }}</span>
                    </div>
                    <div class="plan-desc">Billed monthly</div>
                </label>

                <label class="plan-card" onclick="selectPlan(this, 3)">
                    <input type="radio" name="plan" value="3">
                    <div class="plan-header">
                        <span class="plan-duration">3 Months</span>
                        <div class="plan-check">
                            <i data-lucide="check"></i>
                        </div>
                    </div>
                    <div class="plan-price-row">
                        <span class="plan-currency">GHS</span>
                        <span class="plan-price" data-months="3" id="price3"></span>
                    </div>
                    <div class="plan-desc">Billed quarterly</div>
                </label>

                <label class="plan-card popular" onclick="selectPlan(this, 6)">
                    <input type="radio" name="plan" value="6">
                    <div class="plan-header">
                        <span class="plan-duration">6 Months</span>
                        <div class="plan-check">
                            <i data-lucide="check"></i>
                        </div>
                    </div>
                    <div class="plan-price-row">
                        <span class="plan-currency">GHS</span>
                        <span class="plan-price" data-months="6" id="price6"></span>
                    </div>
                    <div class="plan-desc">Billed semi-annually</div>
                    <span class="plan-savings-badge">Save 5%</span>
                </label>

                <label class="plan-card" onclick="selectPlan(this, 12)">
                    <input type="radio" name="plan" value="12">
                    <div class="plan-header">
                        <span class="plan-duration">12 Months</span>
                        <div class="plan-check">
                            <i data-lucide="check"></i>
                        </div>
                    </div>
                    <div class="plan-price-row">
                        <span class="plan-currency">GHS</span>
                        <span class="plan-price" data-months="12" id="price12"></span>
                    </div>
                    <div class="plan-desc">Billed annually</div>
                    <span class="plan-savings-badge">Best Value</span>
                </label>
            </div>
        </div>

        <!-- Benefits -->
        <div class="benefits-section">
            <h3 class="section-title">
                <i data-lucide="gift"></i>
                Member Benefits
            </h3>
            <div class="benefits-grid">
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i data-lucide="megaphone"></i>
                    </div>
                    <span class="benefit-text">Exclusive announcements and updates from leadership</span>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i data-lucide="mail"></i>
                    </div>
                    <span class="benefit-text">Access to secure internal communications</span>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i data-lucide="book-open"></i>
                    </div>
                    <span class="benefit-text">Exclusive educational resources and materials</span>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i data-lucide="calendar"></i>
                    </div>
                    <span class="benefit-text">Priority invitations to events and activities</span>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i data-lucide="badge"></i>
                    </div>
                    <span class="benefit-text">Official RATEL Movement member badge</span>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i data-lucide="heart"></i>
                    </div>
                    <span class="benefit-text">Support the movement's mission and vision</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="summary-sidebar">
        <div class="summary-card">
            <div class="summary-header">
                <h3>
                    <i data-lucide="receipt"></i>
                    Order Summary
                </h3>
            </div>
            <div class="summary-body">
                <div class="summary-row">
                    <span class="summary-label">Selected Plan</span>
                    <span class="summary-value" id="summaryPlan">1 Month</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Monthly Rate</span>
                    <span class="summary-value">GHS {{ membership_fee_ghs|floatformat:2 }}</span>
                </div>
                {% if currency != "GHS" %}
                <div class="summary-row" style="font-size: 0.8rem; color: #64748b;">
                    <span class="summary-label">Original ({{ currency }})</span>
                    <span class="summary-value">{{ currency }} {{ membership_fee|floatformat:2 }}</span>
                </div>
                {% endif %}
                <div class="summary-divider"></div>
                <div class="summary-total-row">
                    <span class="summary-total-label">Total (GHS)</span>
                    <span class="summary-total-value" id="summaryTotal">GHS {{ membership_fee_ghs|floatformat:2 }}</span>
                </div>
            </div>
            <div class="summary-footer">
                <button class="btn-pay" id="payBtn" onclick="initiatePayment()">
                    <i data-lucide="credit-card"></i>
                    Pay Now in GHS
                </button>
                <div class="secure-badge">
                    <i data-lucide="shield-check"></i>
                    Secured by Paystack - 256-bit SSL
                </div>
                <div class="payment-methods">
                    <span class="payment-method">
                        <i data-lucide="smartphone"></i>
                        Mobile Money
                    </span>
                    <span class="payment-method">
                        <i data-lucide="credit-card"></i>
                        Card
                    </span>
                    <span class="payment-method">
                        <i data-lucide="building"></i>
                        Bank
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal-overlay" id="successModal">
    <div class="success-modal">
        <div class="success-icon-wrapper">
            <i data-lucide="check"></i>
        </div>
        <h2>Payment Successful!</h2>
        <p>Your membership has been renewed successfully.</p>
        <div class="success-details">
            <div class="success-detail-row">
                <span class="success-detail-label">Duration</span>
                <span class="success-detail-value" id="successDuration">1 Month</span>
            </div>
            <div class="success-detail-row">
                <span class="success-detail-label">Valid Until</span>
                <span class="success-detail-value" id="successEndDate">-</span>
            </div>
            <div class="success-detail-row">
                <span class="success-detail-label">Status</span>
                <span class="success-detail-value" style="color: #059669;">Active</span>
            </div>
        </div>
        <button class="btn-done" onclick="window.location.href='{% url 'member_dashboard' %}'">
            Return to Dashboard
        </button>
    </div>
</div>

<!-- Paystack Script -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
    // Original fee in base currency (for reference)
    const originalFee = {{ membership_fee }};
    const originalCurrency = '{{ currency }}';

    // Fee converted to GHS for payment
    const membershipFeeGHS = {{ membership_fee_ghs }};

    const memberEmail = '{{ member_email }}';
    const memberId = '{{ member_id }}';
    const paystackKey = '{{ paystack_public_key }}';

    let selectedMonths = 1;

    const planNames = {
        1: '1 Month',
        3: '3 Months',
        6: '6 Months',
        12: '12 Months'
    };

    function selectPlan(element, months) {
        document.querySelectorAll('.plan-card').forEach(card => {
            card.classList.remove('selected');
        });
        element.classList.add('selected');
        element.querySelector('input').checked = true;
        selectedMonths = months;
        updateSummary();
        lucide.createIcons();
    }

    function updateSummary() {
        const totalGHS = membershipFeeGHS * selectedMonths;
        document.getElementById('summaryPlan').textContent = planNames[selectedMonths];
        document.getElementById('summaryTotal').textContent = 'GHS ' + totalGHS.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function initiatePayment() {
        const totalGHS = membershipFeeGHS * selectedMonths;
        // Paystack expects amount in pesewas (smallest unit) for GHS
        const amountInPesewas = Math.round(totalGHS * 100);

        const payBtn = document.getElementById('payBtn');
        payBtn.classList.add('loading');
        payBtn.disabled = true;

        let handler = PaystackPop.setup({
            key: paystackKey,
            email: memberEmail,
            amount: amountInPesewas,
            currency: 'GHS',
            ref: 'RATEL_' + memberId.replace(/-/g, '') + '_' + Date.now(),
            metadata: {
                member_id: memberId,
                months: selectedMonths,
                original_currency: originalCurrency,
                original_amount: originalFee * selectedMonths,
                custom_fields: [
                    {
                        display_name: "Member ID",
                        variable_name: "member_id",
                        value: memberId
                    },
                    {
                        display_name: "Subscription Duration",
                        variable_name: "months",
                        value: selectedMonths + " month(s)"
                    },
                    {
                        display_name: "Amount (GHS)",
                        variable_name: "amount_ghs",
                        value: "GHS " + totalGHS.toFixed(2)
                    }
                ]
            },
            callback: function(response) {
                verifyPayment(response.reference);
            },
            onClose: function() {
                payBtn.classList.remove('loading');
                payBtn.disabled = false;
            }
        });

        handler.openIframe();
    }

    function verifyPayment(reference) {
        const formData = new FormData();
        formData.append('reference', reference);
        formData.append('months', selectedMonths);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "member_renew_verify" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const payBtn = document.getElementById('payBtn');
            payBtn.classList.remove('loading');
            payBtn.disabled = false;

            if (data.success) {
                document.getElementById('successDuration').textContent = planNames[selectedMonths];
                document.getElementById('successEndDate').textContent = data.end_date || 'Updated';
                document.getElementById('successModal').classList.add('active');
                lucide.createIcons();
            } else {
                alert(data.message || 'Payment verification failed. Please contact support.');
            }
        })
        .catch(error => {
            const payBtn = document.getElementById('payBtn');
            payBtn.classList.remove('loading');
            payBtn.disabled = false;
            alert('An error occurred. Please try again.');
            console.error(error);
        });
    }

    // Countdown Timer
    function initCountdown() {
        const timerEl = document.getElementById('countdownTimer');
        if (!timerEl) return;

        const endDateStr = '{{ subscription_end_iso|default:"" }}';
        if (!endDateStr) return;

        const endDate = new Date(endDateStr);
        const isExpired = '{{ renewal_status }}' === 'expired';

        function updateCountdown() {
            const now = new Date();
            let diff;

            if (isExpired) {
                diff = now - endDate;
            } else {
                diff = endDate - now;
            }

            if (diff < 0 && !isExpired) {
                document.getElementById('countDays').textContent = '0';
                document.getElementById('countHours').textContent = '0';
                document.getElementById('countMins').textContent = '0';
                document.getElementById('countSecs').textContent = '0';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countDays').textContent = Math.abs(days);
            document.getElementById('countHours').textContent = Math.abs(hours);
            document.getElementById('countMins').textContent = Math.abs(mins);
            document.getElementById('countSecs').textContent = Math.abs(secs);
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    }

    // Initialize prices for multi-month plans
    function initPrices() {
        const price3 = document.getElementById('price3');
        const price6 = document.getElementById('price6');
        const price12 = document.getElementById('price12');

        if (price3) price3.textContent = (membershipFeeGHS * 3).toFixed(2);
        if (price6) price6.textContent = (membershipFeeGHS * 6).toFixed(2);
        if (price12) price12.textContent = (membershipFeeGHS * 12).toFixed(2);

        // Update initial summary
        updateSummary();
    }

    document.addEventListener('DOMContentLoaded', function() {
        initCountdown();
        initPrices();
    });
</script>
{% endblock %}
