{% extends "dashboard/base_dashboard.html" %}

{% block title %}Audio - Media Vault{% endblock %}

{% block content %}
<div class="md-space-y-6">

    <!-- Page Header -->
    <div class="md-vault-header">
        <div class="md-vault-header-content">
            <h1 class="md-page-title">Audio</h1>
            <p class="md-page-subtitle">Interviews and official statements</p>
        </div>
        <div class="md-vault-header-actions">
            <div class="md-view-toggle">
                <button class="md-view-btn active" id="gridViewBtn" onclick="setView('grid')">
                    <i data-lucide="grid-3x3" style="width:18px;height:18px;"></i>
                </button>
                <button class="md-view-btn" id="listViewBtn" onclick="setView('list')">
                    <i data-lucide="list" style="width:18px;height:18px;"></i>
                </button>
            </div>
            <button class="md-btn md-btn-primary md-btn-sm" onclick="openUploadModal()">
                <i data-lucide="plus" style="width:16px;height:16px;"></i>
                Add Audio
            </button>
        </div>
    </div>

    <!-- Category Tabs -->
    <div class="md-vault-tabs">
        <button class="md-vault-tab {% if not current_category or current_category == 'all' %}active{% endif %}" onclick="filterCategory('all')">
            All Audio
        </button>
        <button class="md-vault-tab {% if current_category == 'interviews' %}active{% endif %}" onclick="filterCategory('interviews')">
            Interviews
        </button>
        <button class="md-vault-tab {% if current_category == 'statements' %}active{% endif %}" onclick="filterCategory('statements')">
            Statements
        </button>
    </div>

    <!-- Filter Bar -->
    <div class="md-filter-bar">
        <div class="md-filter-search">
            <span class="md-filter-search-icon">
                <i data-lucide="search"></i>
            </span>
            <input type="text" class="md-filter-search-input" placeholder="Search audio files..." id="searchInput" onkeyup="searchMedia()">
        </div>
        <select class="md-filter-select" id="sortSelect" onchange="sortMedia()">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="title">Title A-Z</option>
        </select>
    </div>

    <!-- Audio Grid -->
    <div class="md-media-grid" id="mediaGrid">
        {% if audios %}
            {% for audio in audios %}
            <div class="md-media-card" data-title="{{ audio.title|lower }}" data-category="{{ audio.category }}" data-date="{{ audio.created_at|date:'Y-m-d' }}">
                <div class="md-media-thumb md-audio-thumb">
                    {% if audio.cover_image_url %}
                    <img src="{{ audio.cover_image_url }}" alt="{{ audio.title }}">
                    {% else %}
                    <div class="md-media-thumb-placeholder" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                        <i data-lucide="mic" style="width:56px;height:56px;color:#d97706;"></i>
                    </div>
                    {% endif %}
                    <span class="md-media-badge {{ audio.category }}">{{ audio.category|title }}</span>
                    {% if audio.duration_seconds %}
                    <span class="md-media-duration">{{ audio.duration_seconds|floatformat:0 }}s</span>
                    {% endif %}
                </div>
                <div class="md-audio-waveform">
                    {% for i in "123456789012345678901234567890" %}
                    <div class="md-waveform-bar" style="height:{% widthratio i|length 1 100 %}%;min-height:8px;max-height:40px;"></div>
                    {% endfor %}
                </div>
                <div class="md-media-body">
                    <h3 class="md-media-title">{{ audio.title }}</h3>
                    <p class="md-media-desc">{{ audio.description|default:"No description" }}</p>
                    <div class="md-media-meta">
                        {% if audio.speaker %}
                        <span class="md-media-meta-item">
                            <i data-lucide="user"></i>
                            {{ audio.speaker }}
                        </span>
                        {% endif %}
                        <span class="md-media-meta-item">
                            <i data-lucide="calendar"></i>
                            {{ audio.created_at|date:"M d, Y" }}
                        </span>
                    </div>
                </div>
                <div class="md-media-actions">
                    <audio controls style="width:100%;height:32px;">
                        <source src="{{ audio.file_url }}" type="{{ audio.mime_type|default:'audio/mpeg' }}">
                    </audio>
                </div>
                <div class="md-media-actions" style="border-top:none;padding-top:0;">
                    <a href="{{ audio.file_url }}" download class="md-media-action-btn secondary">
                        <i data-lucide="download"></i>
                        Download
                    </a>
                    <button class="md-media-action-btn danger" onclick="deleteMedia('{{ audio.id }}', 'audio')">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="md-empty-state" style="grid-column: 1 / -1;">
                <i data-lucide="mic-off" class="md-empty-icon"></i>
                <h3 class="md-empty-title">No audio files yet</h3>
                <p class="md-empty-desc">Upload interviews and statements to preserve important audio evidence. Supported formats: MP3, WAV, OGG</p>
                <button class="md-btn md-btn-primary" onclick="openUploadModal()">
                    <i data-lucide="upload" style="width:18px;height:18px;"></i>
                    Upload Audio
                </button>
            </div>
        {% endif %}
    </div>

    <!-- List View (hidden by default) -->
    <div class="md-media-list" id="mediaList" style="display:none;">
        {% if audios %}
            {% for audio in audios %}
            <div class="md-media-list-item" data-title="{{ audio.title|lower }}" data-category="{{ audio.category }}" data-date="{{ audio.created_at|date:'Y-m-d' }}">
                <div class="md-media-list-thumb" style="background:#fef3c7;">
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#d97706;">
                        <i data-lucide="mic" style="width:24px;height:24px;"></i>
                    </div>
                </div>
                <div class="md-media-list-content">
                    <div class="md-media-list-title">{{ audio.title }}</div>
                    <div class="md-media-list-meta">
                        <span class="md-media-badge {{ audio.category }}" style="position:static;">{{ audio.category|title }}</span>
                        {% if audio.speaker %}<span>{{ audio.speaker }}</span>{% endif %}
                        <span>{{ audio.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                <audio controls style="width:200px;height:32px;">
                    <source src="{{ audio.file_url }}" type="{{ audio.mime_type|default:'audio/mpeg' }}">
                </audio>
                <button class="md-media-action-btn danger" onclick="deleteMedia('{{ audio.id }}', 'audio')">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
            {% endfor %}
        {% endif %}
    </div>

</div>

<!-- Upload Modal -->
<div class="md-modal-overlay" id="uploadModal">
    <div class="md-modal">
        <div class="md-modal-header">
            <h2 class="md-modal-title">Add New Audio</h2>
            <button class="md-modal-close" onclick="closeUploadModal()">
                <i data-lucide="x" style="width:20px;height:20px;"></i>
            </button>
        </div>
        <form method="POST" action="{% url 'dashboard_media_audio_save' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="md-modal-body">
                <div class="md-space-y-4">
                    <div class="md-form-group full-width">
                        <label class="md-form-label">Title *</label>
                        <input type="text" name="title" class="md-form-input" placeholder="Enter audio title" required>
                    </div>
                    <div class="md-form-row">
                        <div class="md-form-group">
                            <label class="md-form-label">Category *</label>
                            <select name="category" class="md-form-select" required>
                                <option value="">Select category</option>
                                <option value="interviews">Interviews</option>
                                <option value="statements">Statements</option>
                            </select>
                        </div>
                        <div class="md-form-group">
                            <label class="md-form-label">Speaker</label>
                            <input type="text" name="speaker" class="md-form-input" placeholder="e.g., John Doe">
                        </div>
                    </div>
                    <div class="md-form-group full-width">
                        <label class="md-form-label">Description</label>
                        <textarea name="description" class="md-form-textarea" placeholder="Describe the audio content..."></textarea>
                    </div>
                    <div class="md-form-group full-width">
                        <label class="md-form-label">Audio File *</label>
                        <div class="md-upload-zone" id="audioDropZone" onclick="document.getElementById('audioFile').click()">
                            <i data-lucide="upload-cloud" class="md-upload-icon"></i>
                            <p class="md-upload-text">Click to upload or drag and drop</p>
                            <p class="md-upload-hint">MP3, WAV, OGG up to 100MB</p>
                        </div>
                        <input type="file" name="audio_file" id="audioFile" accept="audio/*" style="display:none;" onchange="handleFileSelect(this, 'audioDropZone')">
                    </div>
                    <div class="md-form-group full-width">
                        <label class="md-form-label">Cover Image (Optional)</label>
                        <input type="file" name="cover_image" class="md-form-input" accept="image/*" style="padding:8px;">
                    </div>
                    <div class="md-form-row">
                        <div class="md-form-group">
                            <label class="md-form-label">Recorded Date</label>
                            <input type="date" name="recorded_date" class="md-form-input">
                        </div>
                        <div class="md-form-group">
                            <label class="md-form-label">Source</label>
                            <input type="text" name="source" class="md-form-input" placeholder="e.g., Radio Interview">
                        </div>
                    </div>
                    <div class="md-form-group full-width">
                        <label class="md-form-label">Transcript (Optional)</label>
                        <textarea name="transcript" class="md-form-textarea" placeholder="Paste or type the audio transcript..." style="min-height:150px;"></textarea>
                    </div>
                </div>
            </div>
            <div class="md-modal-footer">
                <button type="button" class="md-btn md-btn-outline" onclick="closeUploadModal()">Cancel</button>
                <button type="submit" class="md-btn md-btn-primary">
                    <i data-lucide="upload" style="width:16px;height:16px;"></i>
                    Upload Audio
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function setView(view) {
        const grid = document.getElementById('mediaGrid');
        const list = document.getElementById('mediaList');
        const gridBtn = document.getElementById('gridViewBtn');
        const listBtn = document.getElementById('listViewBtn');

        if (view === 'grid') {
            grid.style.display = 'grid';
            list.style.display = 'none';
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        } else {
            grid.style.display = 'none';
            list.style.display = 'flex';
            gridBtn.classList.remove('active');
            listBtn.classList.add('active');
        }
        localStorage.setItem('audioViewMode', view);
    }

    const savedView = localStorage.getItem('audioViewMode');
    if (savedView) setView(savedView);

    function filterCategory(category) {
        const url = new URL(window.location.href);
        if (category === 'all') {
            url.searchParams.delete('category');
        } else {
            url.searchParams.set('category', category);
        }
        window.location.href = url.toString();
    }

    function searchMedia() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.md-media-card, .md-media-list-item');
        cards.forEach(card => {
            const title = card.getAttribute('data-title');
            card.style.display = title.includes(query) ? '' : 'none';
        });
    }

    function sortMedia() {
        const sort = document.getElementById('sortSelect').value;
        const grid = document.getElementById('mediaGrid');
        const cards = Array.from(grid.querySelectorAll('.md-media-card'));

        cards.sort((a, b) => {
            if (sort === 'newest') {
                return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
            } else if (sort === 'oldest') {
                return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
            } else {
                return a.getAttribute('data-title').localeCompare(b.getAttribute('data-title'));
            }
        });
        cards.forEach(card => grid.appendChild(card));
    }

    function openUploadModal() {
        document.getElementById('uploadModal').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('open');
        document.body.style.overflow = '';
    }

    document.getElementById('uploadModal').addEventListener('click', function(e) {
        if (e.target === this) closeUploadModal();
    });

    function handleFileSelect(input, zoneId) {
        const zone = document.getElementById(zoneId);
        if (input.files && input.files[0]) {
            const file = input.files[0];
            zone.innerHTML = `
                <i data-lucide="check-circle" class="md-upload-icon" style="color:var(--md-green);"></i>
                <p class="md-upload-text">${file.name}</p>
                <p class="md-upload-hint">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            `;
            lucide.createIcons();
        }
    }

    const dropZone = document.getElementById('audioDropZone');
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });
        dropZone.addEventListener('drop', function(e) {
            document.getElementById('audioFile').files = e.dataTransfer.files;
            handleFileSelect(document.getElementById('audioFile'), 'audioDropZone');
        }, false);
    }

    function deleteMedia(id, type) {
        if (confirm('Are you sure you want to delete this ' + type + '?')) {
            fetch('{% url "dashboard_media_audio_delete" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ id: id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) window.location.reload();
                else alert('Failed to delete: ' + (data.error || 'Unknown error'));
            });
        }
    }

    if (typeof lucide !== 'undefined') lucide.createIcons();
</script>
{% endblock %}
