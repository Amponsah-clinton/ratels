{% extends "dashboard/base_dashboard.html" %}

{% block title %}{% if status_filter == 'suspended' %}Suspended Members{% elif status_filter == 'banned' %}Banned Accounts{% else %}Membership{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .md-members-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .md-members-meta {
    font-size: 0.85rem;
    color: var(--md-muted);
  }
  .md-members-filters {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .md-members-search-input {
    border-radius: 999px;
    border: 1px solid #d1d5db;
    padding: 6px 10px;
    font-size: 0.8rem;
    min-width: 180px;
  }
  .md-members-role-filter {
    border-radius: 999px;
    border: 1px solid #d1d5db;
    padding: 6px 10px;
    font-size: 0.8rem;
  }
  .md-members-table-wrapper {
    overflow-x: auto;
  }
  .md-members-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  .md-members-table thead {
    background: #1f2937;
    color: #f9fafb;
  }
  .md-members-table thead th {
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .md-members-table th,
  .md-members-table td {
    padding: 10px 12px;
    text-align: left;
    white-space: nowrap;
  }
  .md-members-table tbody tr:nth-child(even) {
    background: #f9fafb;
  }
  .md-members-table tbody tr:nth-child(odd) {
    background: #ffffff;
  }
  .md-members-table tbody tr:hover {
    background: #f3f4f6;
  }
  .md-members-table tbody tr.status-suspended { background: #fffbeb; }
  .md-members-table tbody tr.status-suspended:hover { background: #fef3c7; }
  .md-members-table tbody tr.status-banned { background: #fef2f2; }
  .md-members-table tbody tr.status-banned:hover { background: #fee2e2; }
  .md-member-name {
    font-weight: 600;
    color: #111827;
  }
  .md-member-role-pill {
    display: inline-flex;
    align-items: center;
    margin-top: 4px;
    padding: 2px 8px;
    border-radius: 999px;
    background: #fef3c7;
    color: #92400e;
    font-size: 0.75rem;
    border: 1px solid #fcd34d;
  }
  .md-member-email {
    font-size: 0.8rem;
    color: #6b7280;
  }
  .md-member-id-pill {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    background: #ecfeff;
    color: #0369a1;
    font-size: 0.78rem;
    font-weight: 500;
    border: 1px solid #bae6fd;
  }
  .md-member-location {
    font-size: 0.82rem;
    color: #374151;
  }
  .md-member-engagement {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .md-member-avatar {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    flex-shrink: 0;
    cursor: pointer;
    background: #e5e7eb;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .md-member-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .md-member-tag {
    padding: 2px 8px;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
    font-size: 0.75rem;
    border: 1px solid #bfdbfe;
  }
  .md-member-joined {
    font-size: 0.8rem;
    color: #6b7280;
  }
  .md-member-avatar-btn {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #e5e7eb;
    color: #111827;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
  }
  .md-member-avatar-btn:hover {
    background: #d1d5db;
  }
  /* Allow main text columns to wrap */
  .md-members-table td:nth-child(2),
  .md-members-table td:nth-child(3),
  .md-members-table td:nth-child(5),
  .md-members-table td:nth-child(6),
  .md-members-table td:nth-child(7) {
    white-space: normal;
  }
  .md-member-select {
    border-radius: 999px;
    border: 1px solid #d1d5db;
    padding: 4px 10px;
    font-size: 0.78rem;
    background: #f9fafb;
  }
  .md-member-btn {
    border-radius: 999px;
    border: none;
    padding: 4px 10px;
    font-size: 0.78rem;
    cursor: pointer;
  }
  .md-member-btn-primary {
    background: #111827;
    color: #f9fafb;
  }
  .md-member-btn-secondary {
    background: #e5e7eb;
    color: #111827;
  }
  .md-member-btn-danger {
    background: #fee2e2;
    color: #991b1b;
  }
  .md-member-btn-warning {
    background: #fef3c7;
    color: #92400e;
  }
  .md-member-btn-success {
    background: #d1fae5;
    color: #065f46;
  }
  /* Status badges — flat solid, no gradient */
  .md-status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  .md-status-badge-active {
    background: #e5e7eb;
    color: #374151;
  }
  .md-status-badge-suspended {
    background: #fef3c7;
    color: #92400e;
  }
  .md-status-badge-banned {
    background: #fee2e2;
    color: #991b1b;
  }
  .md-actions-cell {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
  }
  .md-member-icon-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 4px;
    border-radius: 999px;
  }
  .md-member-icon-btn:hover {
    background: #e5e7eb;
  }
  @media (max-width: 768px) {
    .md-members-table th,
    .md-members-table td {
      padding: 8px 10px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="md-space-y-6">

    <!-- Page Header -->
    <div class="md-page-header-row">
        <div>
            <h1 class="md-page-title">{% if status_filter == 'suspended' %}Suspended Members{% elif status_filter == 'banned' %}Banned Accounts{% else %}Membership{% endif %}</h1>
            <p class="md-page-subtitle">{% if status_filter == 'suspended' %}Members currently suspended{% elif status_filter == 'banned' %}Accounts that have been banned{% else %}All registered RATEL members{% endif %}</p>
        </div>
    </div>

    <!-- Members table -->
    <div class="md-card">
        <div class="md-card-header md-members-card-header">
            <div>
                <h2 class="md-card-title">{% if status_filter == 'suspended' %}Suspended Members{% elif status_filter == 'banned' %}Banned Accounts{% else %}Registered Members{% endif %}</h2>
                <p class="md-members-meta">{% if status_filter == 'suspended' %}Members currently suspended from the movement.{% elif status_filter == 'banned' %}Accounts that have been permanently banned.{% else %}Overview of everyone who has joined the RATEL Movement.{% endif %}</p>
            </div>
            <div class="md-members-filters">
                <input
                    id="membersSearch"
                    type="search"
                    class="md-members-search-input"
                    placeholder="Search name, email, ID, phone..."
                    autocomplete="off"
                >
                <select id="membersRoleFilter" class="md-members-role-filter">
                    <option value="">All roles</option>
                    <option value="Full member">Full member</option>
                    <option value="Associate member">Associate member</option>
                    <option value="Honorary member">Honorary member</option>
                    <option value="Temporary member">Temporary member</option>
                    <option value="Patron">Patron</option>
                    <option value="No specific role">No specific role</option>
                </select>
                <span class="md-members-meta">
                    Total: <strong id="membersCount">{{ members|length|default:"0" }}</strong>
                </span>
            </div>
        </div>
        <div class="md-card-content md-members-table-wrapper">
            {% if members %}
            <table class="md-members-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Member</th>
                        <th>Member ID</th>
                        <th>Status</th>
                        <th>Role</th>
                        <th>Contact</th>
                        <th>Location</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in members %}
                    <tr class="status-{{ m.status|default:'active' }}">
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:8px;">
                              <button
                                type="button"
                                class="md-member-avatar md-member-avatar-trigger"
                                title="View profile picture"
                                data-image-url="{{ m.profile_image_url|default_if_none:'' }}"
                                aria-label="View profile picture for {{ m.full_name }}"
                              >
                                {% if m.profile_image_url %}
                                  <img src="{{ m.profile_image_url }}" alt="{{ m.full_name }} profile">
                                {% else %}
                                  <i data-lucide="user" style="width:16px;height:16px;color:#4b5563;"></i>
                                {% endif %}
                              </button>
                              <div>
                                <div class="md-member-name">{{ m.full_name }}</div>
                                <div class="md-member-email">{{ m.email }}</div>
                              </div>
                            </div>
                        </td>
                        <td>
                            <div class="md-member-id-pill">{{ m.member_id }}</div>
                        </td>
                        <td>
                            {% with st=m.status|default:"active" %}
                            {% if st == "suspended" %}
                                <span class="md-status-badge md-status-badge-suspended">Suspended</span>
                            {% elif st == "banned" %}
                                <span class="md-status-badge md-status-badge-banned">Banned</span>
                            {% else %}
                                <span class="md-status-badge md-status-badge-active">Active</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% if m.membership_type %}
                                <div class="md-member-role-pill">{{ m.membership_type }}</div>
                            {% else %}
                                <span class="md-member-joined">—</span>
                            {% endif %}
                            <form method="post" action="{% url 'dashboard_membership_actions' %}" style="margin-top:6px;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="role">
                                <input type="hidden" name="member_id" value="{{ m.member_id }}">
                                <input type="hidden" name="email" value="{{ m.email }}">
                                <select name="membership_type" class="md-member-select">
                                    <option value="">No role</option>
                                    <option value="Full member" {% if m.membership_type == 'Full member' %}selected{% endif %}>Full member</option>
                                    <option value="Associate member" {% if m.membership_type == 'Associate member' %}selected{% endif %}>Associate</option>
                                    <option value="Honorary member" {% if m.membership_type == 'Honorary member' %}selected{% endif %}>Honorary</option>
                                    <option value="Temporary member" {% if m.membership_type == 'Temporary member' %}selected{% endif %}>Temporary</option>
                                    <option value="Patron" {% if m.membership_type == 'Patron' %}selected{% endif %}>Patron</option>
                                </select>
                                <button type="submit" class="md-member-btn md-member-btn-primary" style="margin-top:4px;">Save</button>
                            </form>
                        </td>
                        <td>
                            {% if m.phone_number %}
                                <div class="md-member-joined">{{ m.phone_number }}</div>
                            {% else %}
                                <div class="md-member-joined">-</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="md-member-location">
                                {% if m.based_in_nigeria %}
                                    NG{% if m.state %} · {{ m.state }}{% endif %}{% if m.lga %} ({{ m.lga }}){% endif %}
                                {% else %}
                                    {{ m.country }}{% if m.city %} · {{ m.city }}{% endif %}
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if m.created_at %}
                                <span class="md-member-joined">{{ m.created_at|slice:10 }}</span>
                            {% else %}
                                <span class="md-member-joined">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="md-actions-cell">
                                <button
                                    type="button"
                                    class="md-member-icon-btn md-member-edit-btn"
                                    title="Edit details"
                                    data-member-id="{{ m.member_id }}"
                                    data-full-name="{{ m.full_name }}"
                                    data-email="{{ m.email }}"
                                    data-phone="{{ m.phone_number }}"
                                    data-based-ng="{{ m.based_in_nigeria }}"
                                    data-state="{{ m.state }}"
                                    data-lga="{{ m.lga }}"
                                    data-country="{{ m.country }}"
                                    data-city="{{ m.city }}"
                                >
                                    <i data-lucide="pencil" style="width:16px;height:16px;"></i>
                                </button>
                                {% if m.status == 'banned' %}
                                    <form method="post" action="{% url 'dashboard_membership_actions' %}" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="unban">
                                        <input type="hidden" name="member_id" value="{{ m.member_id }}">
                                        <input type="hidden" name="email" value="{{ m.email }}">
                                        <button type="submit" class="md-member-btn md-member-btn-success" title="Unban and reinstate">Unban</button>
                                    </form>
                                {% else %}
                                    <form method="post" action="{% url 'dashboard_membership_actions' %}" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="suspend">
                                        <input type="hidden" name="member_id" value="{{ m.member_id }}">
                                        <input type="hidden" name="email" value="{{ m.email }}">
                                        {% if m.status == 'suspended' %}
                                            <input type="hidden" name="status" value="active">
                                            <button type="submit" class="md-member-btn md-member-btn-success">Reinstate</button>
                                        {% else %}
                                            <input type="hidden" name="status" value="suspended">
                                            <button type="submit" class="md-member-btn md-member-btn-warning">Suspend</button>
                                        {% endif %}
                                    </form>
                                    <form method="post" action="{% url 'dashboard_membership_actions' %}" style="display:inline;" onsubmit="return confirm('Permanently ban this member? They will not be able to log in.');">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="ban">
                                        <input type="hidden" name="member_id" value="{{ m.member_id }}">
                                        <input type="hidden" name="email" value="{{ m.email }}">
                                        <button type="submit" class="md-member-btn md-member-btn-danger" title="Ban permanently">Ban</button>
                                    </form>
                                {% endif %}
                                <form method="post" action="{% url 'dashboard_membership_actions' %}" style="display:inline;" onsubmit="return confirm('Delete this member permanently?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="member_id" value="{{ m.member_id }}">
                                    <input type="hidden" name="email" value="{{ m.email }}">
                                    <button type="submit" class="md-member-btn md-member-btn-danger" title="Delete">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="md-empty-state">
                No members registered yet.
            </p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    const searchInput = document.getElementById('membersSearch');
    const roleFilter = document.getElementById('membersRoleFilter');
    const table = document.querySelector('.md-members-table');
    const countEl = document.getElementById('membersCount');

    if (!table || !searchInput || !roleFilter || !countEl) return;

    const rows = Array.from(table.querySelectorAll('tbody tr'));

    function normalize(text) {
      return (text || '').toString().toLowerCase();
    }

    function getRowRole(row) {
      const rolePill = row.querySelector('.md-member-role-pill');
      const roleText = rolePill ? rolePill.textContent.trim() : 'No specific role';
      return roleText || 'No specific role';
    }

    function getRowSearchText(row) {
      const tds = row.querySelectorAll('td');
      let text = '';
      tds.forEach(td => {
        text += ' ' + td.textContent;
      });
      return normalize(text);
    }

    function applyFilters() {
      const term = normalize(searchInput.value);
      const roleValue = roleFilter.value;
      let visibleCount = 0;

      rows.forEach(row => {
        const rowText = getRowSearchText(row);
        const rowRole = getRowRole(row);

        const matchesSearch = !term || rowText.includes(term);
        const matchesRole = !roleValue || rowRole === roleValue;

        if (matchesSearch && matchesRole) {
          row.style.display = '';
          visibleCount += 1;
        } else {
          row.style.display = 'none';
        }
      });

      countEl.textContent = visibleCount.toString();
    }

    searchInput.addEventListener('input', applyFilters);
    roleFilter.addEventListener('change', applyFilters);
  })();
</script>
<script>
  (function () {
    const editButtons = document.querySelectorAll('.md-member-edit-btn');
    if (!editButtons.length) return;

    let modal = document.getElementById('memberEditModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'memberEditModal';
      modal.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,0.55);z-index:12000;padding:16px;';
      modal.innerHTML = `
        <div style="background:#ffffff;border-radius:12px;max-width:480px;width:100%;padding:20px 22px;box-shadow:0 20px 40px rgba(15,23,42,0.4);position:relative;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="font-size:1rem;font-weight:600;color:#0f172a;">Edit member details</h3>
            <button type="button" id="memberEditClose" style="border:none;background:transparent;cursor:pointer;font-size:18px;line-height:1;">×</button>
          </div>
          <form method="post" action="{% url 'dashboard_membership_actions' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_info">
            <input type="hidden" name="member_id" id="edit_member_id">
            <input type="hidden" name="original_email" id="edit_original_email">
            <div style="display:grid;gap:10px;margin-top:4px;">
              <div>
                <label style="font-size:0.8rem;color:#4b5563;">Full name</label>
                <input type="text" name="full_name" id="edit_full_name" required
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;">
              </div>
              <div>
                <label style="font-size:0.8rem;color:#4b5563;">Email</label>
                <input type="email" name="email" id="edit_email" required
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;">
              </div>
              <div>
                <label style="font-size:0.8rem;color:#4b5563;">Phone number</label>
                <input type="text" name="phone_number" id="edit_phone" required
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;">
              </div>
              <div>
                <label style="font-size:0.8rem;color:#4b5563;display:block;">Based in Nigeria?</label>
                <label style="font-size:0.8rem;color:#374151;margin-right:10px;">
                  <input type="radio" name="based_in_nigeria" value="yes" id="edit_based_ng_yes"> Yes
                </label>
                <label style="font-size:0.8rem;color:#374151;">
                  <input type="radio" name="based_in_nigeria" value="no" id="edit_based_ng_no"> No (foreigner)
                </label>
              </div>
              <div id="edit_ng_fields">
                <label style="font-size:0.8rem;color:#4b5563;">State</label>
                <input type="text" name="state" id="edit_state"
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;margin-bottom:6px;">
                <label style="font-size:0.8rem;color:#4b5563;">LGA</label>
                <input type="text" name="lga" id="edit_lga"
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;">
              </div>
              <div id="edit_foreign_fields">
                <label style="font-size:0.8rem;color:#4b5563;">Country</label>
                <input type="text" name="country" id="edit_country"
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;margin-bottom:6px;">
                <label style="font-size:0.8rem;color:#4b5563;">City</label>
                <input type="text" name="city" id="edit_city"
                       style="width:100%;border-radius:8px;border:1px solid #d1d5db;padding:6px 10px;font-size:0.85rem;">
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
              <button type="button" id="memberEditCancel"
                      style="border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;padding:6px 14px;font-size:0.8rem;cursor:pointer;">
                Cancel
              </button>
              <button type="submit"
                      style="border-radius:999px;border:none;background:#111827;color:#f9fafb;padding:6px 16px;font-size:0.8rem;cursor:pointer;">
                Save changes
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    const idInput = modal.querySelector('#edit_member_id');
    const originalEmailInput = modal.querySelector('#edit_original_email');
    const fullNameInput = modal.querySelector('#edit_full_name');
    const emailInput = modal.querySelector('#edit_email');
    const phoneInput = modal.querySelector('#edit_phone');
    const basedYes = modal.querySelector('#edit_based_ng_yes');
    const basedNo = modal.querySelector('#edit_based_ng_no');
    const stateInput = modal.querySelector('#edit_state');
    const lgaInput = modal.querySelector('#edit_lga');
    const countryInput = modal.querySelector('#edit_country');
    const cityInput = modal.querySelector('#edit_city');
    const ngFields = modal.querySelector('#edit_ng_fields');
    const foreignFields = modal.querySelector('#edit_foreign_fields');

    function setLocationVisibility(isNg) {
      if (isNg) {
        ngFields.style.display = 'block';
        foreignFields.style.display = 'none';
      } else {
        ngFields.style.display = 'none';
        foreignFields.style.display = 'block';
      }
    }

    editButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const memberId = btn.dataset.memberId || '';
        const fullName = btn.dataset.fullName || '';
        const email = btn.dataset.email || '';
        const phone = btn.dataset.phone || '';
        const basedNg = (btn.dataset.basedNg || '').toLowerCase() === 'true';
        const state = btn.dataset.state || '';
        const lga = btn.dataset.lga || '';
        const country = btn.dataset.country || '';
        const city = btn.dataset.city || '';

        idInput.value = memberId;
        originalEmailInput.value = email;
        fullNameInput.value = fullName;
        emailInput.value = email;
        phoneInput.value = phone;

        if (basedNg) {
          basedYes.checked = true;
          basedNo.checked = false;
          setLocationVisibility(true);
        } else {
          basedYes.checked = false;
          basedNo.checked = true;
          setLocationVisibility(false);
        }

        stateInput.value = state;
        lgaInput.value = lga;
        countryInput.value = country;
        cityInput.value = city;

        modal.style.display = 'flex';
      });
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
    const closeBtn = modal.querySelector('#memberEditClose');
    const cancelBtn = modal.querySelector('#memberEditCancel');
    [closeBtn, cancelBtn].forEach(btn => {
      if (btn) {
        btn.addEventListener('click', () => {
          modal.style.display = 'none';
        });
      }
    });

    basedYes.addEventListener('change', () => setLocationVisibility(true));
    basedNo.addEventListener('change', () => setLocationVisibility(false));
  })();
</script>
<script>
  (function () {
    const avatarButtons = document.querySelectorAll('.md-member-avatar-trigger');
    if (!avatarButtons.length) return;

    let modal = document.getElementById('memberPhotoModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'memberPhotoModal';
      modal.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);z-index:13000;padding:16px;';
      modal.innerHTML = `
        <div style="position:relative;max-width:480px;width:100%;background:#ffffff;border-radius:12px;padding:16px;box-shadow:0 20px 40px rgba(15,23,42,0.5);">
          <button type="button" id="memberPhotoClose"
                  style="position:absolute;top:10px;right:10px;border:none;background:#f3f4f6;border-radius:999px;width:28px;height:28px;cursor:pointer;font-size:18px;line-height:1;">
            &times;
          </button>
          <div style="text-align:center;padding-top:18px;">
            <img id="memberPhotoImage"
                 src=""
                 alt="Member profile picture"
                 style="max-width:100%;max-height:70vh;border-radius:8px;object-fit:contain;">
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    const imageEl = modal.querySelector('#memberPhotoImage');
    const closeBtn = modal.querySelector('#memberPhotoClose');

    avatarButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.imageUrl;
        if (!url) {
          return;
        }
        imageEl.src = url;
        modal.style.display = 'flex';
      });
    });

    function hideModal() {
      modal.style.display = 'none';
      imageEl.src = '';
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', hideModal);
    }
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        hideModal();
      }
    });
  })();
</script>
{% endblock %}
